<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motorista - Santa Terezinha</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --bg-color: #f1f2f6;
            --text-dark: #2d3436;
            --text-gray: #636e72;
            --white: #ffffff;
            --danger: #ff7675;
            --success: #00b894;
            --warning: #fdcb6e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { background-color: var(--bg-color); color: var(--text-dark); padding: 20px; }

        /* HEADER */
        header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-size: 24px; color: var(--text-dark); }
        header p { color: var(--text-gray); font-size: 14px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; }
        .logout-btn { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* KPI CARDS */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            border-top: 4px solid var(--primary);
        }

        .kpi-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .kpi-title { font-size: 12px; font-weight: bold; color: var(--text-gray); text-transform: uppercase; letter-spacing: 1px; }
        .kpi-icon { 
            background: var(--primary); 
            color: white; 
            width: 40px; height: 40px; 
            border-radius: 10px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }
        
        .kpi-number { font-size: 36px; font-weight: bold; color: var(--text-dark); margin-bottom: 5px; }
        .kpi-sub { font-size: 12px; color: var(--text-gray); }

        /* NAVBAR */
        .nav-tabs {
            background: var(--white);
            padding: 0 20px;
            border-radius: 30px;
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            overflow-x: auto;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 20px 15px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-gray);
            cursor: pointer;
            position: relative;
            transition: 0.3s;
            white-space: nowrap;
        }

        .tab-btn:hover { color: var(--primary); }
        
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }

        .tab-btn i { margin-right: 8px; }

        /* CONTE√öDO DAS ABAS */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* BOT√ïES E FORMUL√ÅRIOS */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-action {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
            transition: 0.2s;
        }
        .btn-action:hover { background: #5649c0; transform: translateY(-2px); }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; color: var(--text-dark); }
        .form-control {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;
            background: var(--white);
        }

        .btn { padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        /* CARDS */
        .card {
            background: var(--white);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-block; }
        .st-active { background: #dff9fb; color: var(--success); }
        .st-inactive { background: #ffeaa7; color: #fdcb6e; }
        .st-danger { background: #ff7675; color: white; }
        .st-warning { background: #ffeaa7; color: #fdcb6e; }

        /* MODAL */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;
            animation: popIn 0.3s; max-height: 90vh; overflow-y: auto;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .loading { text-align: center; padding: 40px; color: var(--text-gray); }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-gray); }
        .empty-state i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Painel do Motorista</h1>
            <p>Gerencie suas atividades e reporte problemas</p>
        </div>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar" onclick="abrirModalPerfil()">M</div>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
    </header>

    <div class="kpi-container">
        <div class="kpi-card">
            <div class="kpi-header">
                <span class="kpi-title">Status da Linha</span>
                <div class="kpi-icon"><i class="fas fa-route"></i></div>
            </div>
            <div class="kpi-number" id="statusLinha">Parada</div>
            <div class="kpi-sub" id="statusDesc">Aguardando in√≠cio da jornada</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-header">
                <span class="kpi-title">Escala de Hoje</span>
                <div class="kpi-icon"><i class="fas fa-calendar"></i></div>
            </div>
            <div class="kpi-number" id="escalaHoje">06:00</div>
            <div class="kpi-sub" id="escalaDesc">Centro - S√£o Jos√©</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-header">
                <span class="kpi-title">Chamados Enviados</span>
                <div class="kpi-icon"><i class="fas fa-tools"></i></div>
            </div>
            <div class="kpi-number" id="chamadosEnviados">0</div>
            <div class="kpi-sub">Aguardando resposta</div>
        </div>
    </div>

    <nav class="nav-tabs">
        <button class="tab-btn active" onclick="openTab(event, 'problemas')"><i class="fas fa-exclamation-triangle"></i> Reportar Problemas</button>
        <button class="tab-btn" onclick="openTab(event, 'escala')"><i class="fas fa-calendar-alt"></i> Minha Escala</button>
        <button class="tab-btn" onclick="openTab(event, 'controle')"><i class="fas fa-bus"></i> Controle de Linha</button>
    </nav>
        
    <div id="problemas" class="tab-content active">
        <div class="section-header">
            <h3>Reportar Problemas</h3>
        </div>
        
        <form id="problemaForm" style="background: var(--white); padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <div class="form-group">
                    <label for="tipoProblema">Tipo de Problema:</label>
                    <select id="tipoProblema" class="form-control" required>
                        <option value="">Selecione o tipo</option>
                        <option value="mecanico">üîß Problema Mec√¢nico</option>
                        <option value="eletrico">‚ö° Problema El√©trico</option>
                        <option value="pneu">üõû Problema com Pneus</option>
                        <option value="outro">‚ùì Outro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="urgencia">Urg√™ncia:</label>
                    <select id="urgencia" class="form-control" required>
                        <option value="baixa">üü¢ Baixa</option>
                        <option value="media">üü° M√©dia</option>
                        <option value="alta">üü† Alta</option>
                        <option value="critica">üî¥ Cr√≠tica</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="descricaoProblema">Descri√ß√£o do Problema:</label>
                    <textarea id="descricaoProblema" class="form-control" rows="4" placeholder="Descreva o problema em detalhes..." required></textarea>
                </div>

            <button type="submit" class="btn-action">
                <i class="fas fa-paper-plane"></i> Enviar Chamado
            </button>
        </form>
    </div>
    
    <div id="escala" class="tab-content">
        <div class="section-header">
            <h3>Minha Escala</h3>
        </div>
        
        <div id="escalasList">
            <div class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando escalas...</div>
        </div>
    </div>
    
        <div id="controle" class="tab-content">
        <div class="section-header">
            <h3>Controle de Linha</h3>
            <p style="color: var(--text-gray); font-size: 0.9rem; margin-top: 5px;">
                <i class="fas fa-link" style="margin-right: 5px;"></i>
                Conectado com sua <a href="#" onclick="openTab(event, 'escala')" style="color: var(--primary); text-decoration: underline; font-weight: 600;">escala de hoje</a>
            </p>
        </div>
        
        <!-- Status da Linha -->
        <div class="linha-status" style="text-align: center; padding: 30px; background: var(--white); border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
            <div class="status-icon" id="statusIcon" style="width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2rem; background: #f3f4f6; color: var(--text-gray);">
                <i class="fas fa-pause"></i>
            </div>
            <h3 id="statusTitle" style="font-size: 1.5rem; margin-bottom: 10px; color: var(--text-dark);">Linha Parada</h3>
            <p id="statusSubtitle" style="color: var(--text-gray); margin-bottom: 30px;">Aguardando in√≠cio da jornada</p>
            
            <div style="margin: 30px 0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="padding: 15px; background: #f8fafc; border-radius: 10px; border-left: 4px solid var(--primary);">
                        <p style="font-size: 0.875rem; color: var(--text-gray); margin-bottom: 5px; font-weight: 500;">VE√çCULO</p>
                        <p style="font-weight: 600; font-size: 1.1rem; color: var(--text-dark);" id="veiculoAtual">Selecione um ve√≠culo</p>
                    </div>
                    <div style="padding: 15px; background: #f8fafc; border-radius: 10px; border-left: 4px solid var(--success);">
                        <p style="font-size: 0.875rem; color: var(--text-gray); margin-bottom: 5px; font-weight: 500;">HOR√ÅRIO</p>
                        <p style="font-weight: 600; font-size: 1.1rem; color: var(--text-dark);" id="horarioAtual">06:00 - 14:00</p>
                    </div>
                    <div style="padding: 15px; background: #f8fafc; border-radius: 10px; border-left: 4px solid var(--warning);">
                        <p style="font-size: 0.875rem; color: var(--text-gray); margin-bottom: 5px; font-weight: 500;">LINHA</p>
                        <p style="font-weight: 600; font-size: 1.1rem; color: var(--text-dark);" id="linhaAtual">Centro - S√£o Jos√©</p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <div style="margin-bottom: 20px;">
                    <div class="status-linha-container" id="statusContainer" style="display: inline-flex; align-items: center; padding: 10px 20px; border-radius: 25px; background: #f8f9fa;">
                        <div id="statusIndicator" class="status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: var(--text-gray); margin-right: 10px;"></div>
                        <span id="statusText" style="font-weight: 600; color: var(--text-gray);">Status: Parada</span>
                    </div>
                </div>
                <button class="btn-action" id="btnControle" onclick="toggleLinha()" disabled style="min-width: 200px; padding: 15px 30px; font-size: 1.1rem; font-weight: 600; opacity: 0.5; cursor: not-allowed;">
                    <i class="fas fa-play" id="btnIcon"></i> 
                    <span id="btnText">Iniciar Linha</span>
                </button>
                <p style="margin-top: 15px; color: var(--text-gray); font-size: 0.9rem;">
                    <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                    Os dados s√£o carregados automaticamente da sua <a href="#" onclick="openTab(event, 'escala')" style="color: var(--primary); text-decoration: underline; font-weight: 600;">escala de hoje</a>
                </p>
            </div>
        </div>
        
        <!-- Hist√≥rico de Linhas -->
        <div style="margin-top: 30px; padding: 20px; background: var(--white); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <h4 style="margin-bottom: 15px; color: var(--text-dark); display: flex; align-items: center;">
                <i class="fas fa-history" style="margin-right: 8px; color: var(--primary);"></i>
                Hist√≥rico de Hoje
            </h4>
            <div id="historicoLinhas">
                <p style="color: var(--text-gray); text-align: center; padding: 20px;">Nenhuma linha executada hoje</p>
            </div>
        </div>
    </div>

    <!-- Modal de Perfil -->
    <div id="modalPerfil" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">Perfil do Motorista</h2>
                <button onclick="fecharModalPerfil()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.5rem; border-radius: 50%; transition: all 0.3s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 2rem; color: white; font-weight: 700;" id="modalAvatar">
                    CS
                </div>
                <h3 style="font-size: 1.25rem; font-weight: 600; color: #1f2937; margin: 0;" id="modalNome">Carlos Silva</h3>
                <p style="color: #6b7280; margin: 0.5rem 0 0 0;" id="modalCargo">Motorista</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8fafc; border-radius: 12px;">
                    <p style="font-size: 0.875rem; color: #6b7280; margin: 0 0 0.5rem 0; font-weight: 500;">CPF</p>
                    <p style="font-size: 1rem; color: #1f2937; margin: 0; font-weight: 600;" id="modalCpf">123.456.789-00</p>
                </div>
                
                <div style="padding: 1rem; background: #f8fafc; border-radius: 12px;">
                    <p style="font-size: 0.875rem; color: #6b7280; margin: 0 0 0.5rem 0; font-weight: 500;">TELEFONE</p>
                    <p style="font-size: 1rem; color: #1f2937; margin: 0; font-weight: 600;">(49) 99999-8888</p>
                </div>
            </div>
            
            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; text-align: center;">
                <button onclick="fecharModalPerfil()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 0.75rem 2rem; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <i class="fas fa-check" style="margin-right: 8px;"></i>Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background: #6b7280; color: white; padding: 2rem 0 1rem; margin-top: 3rem;">
        <div class="container">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; margin-bottom: 1.5rem;">
                <div>
                    <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.8rem; color: white;">Sistema Santa Terezinha</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">Sistema de gest√£o de transporte p√∫blico</li>
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">Fraiburgo/SC</li>
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">Transporte urbano</li>
                    </ul>
                </div>
                <div>
                    <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.8rem; color: white;">Contato</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">contato@santaterezinha.com</li>
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">(49) 99999-9999</li>
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">WhatsApp: (49) 99999-8888</li>
                    </ul>
                </div>
                <div>
                    <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.8rem; color: white;">Funcionalidades</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">
                            <a href="#" onclick="openTab('escala')" style="color: white; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#ffd700'" onmouseout="this.style.color='white'">
                                Minha Escala
                            </a>
                        </li>
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">
                            <a href="#" onclick="openTab('controle')" style="color: white; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#ffd700'" onmouseout="this.style.color='white'">
                                Controle de Linha
                            </a>
                        </li>
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">
                            <a href="#" onclick="openTab('chamados')" style="color: white; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#ffd700'" onmouseout="this.style.color='white'">
                                Reportar Problemas
                            </a>
                        </li>
                    </ul>
                </div>
                <div>
                    <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.8rem; color: white;">Redes Sociais</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">
                            <a href="#" style="color: white; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#ffd700'" onmouseout="this.style.color='white'">
                                Facebook
                            </a>
                        </li>
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">
                            <a href="#" style="color: white; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#ffd700'" onmouseout="this.style.color='white'">
                                Instagram
                            </a>
                        </li>
                        <li style="margin-bottom: 0.4rem; font-size: 0.9rem;">
                            <a href="#" style="color: white; text-decoration: none; transition: color 0.3s;" onmouseover="this.style.color='#ffd700'" onmouseout="this.style.color='white'">
                                Twitter
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div style="border-top: 1px solid rgba(255, 255, 255, 0.3); padding-top: 1rem; text-align: center;">
                <p style="color: white; font-size: 0.9rem; margin: 0; font-weight: 500;">
                    Sistema Santa Terezinha - Fraiburgo/SC<br>
                    Rua das Flores, 123 - Centro - CEP: 89580-000<br>
                    Telefone: (49) 99999-9999 | Email: contato@santaterezinha.com
                </p>
                <p style="color: rgba(255, 255, 255, 0.8); font-size: 0.8rem; margin: 0.5rem 0 0 0;">
                    &copy; 2024 Sistema Santa Terezinha. Desenvolvido para melhorar sua experi√™ncia no transporte p√∫blico.
                </p>
            </div>
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script>
        // Estado da aplica√ß√£o
        // usuarioAtual e statusLinha j√° est√£o declarados globalmente em app.js
        let veiculoSelecionado = null;
        let historicoLinhas = [];
        let escalaAtual = null; // Armazena a escala atual do motorista

        // Fun√ß√£o auxiliar para normalizar data (garante compara√ß√£o correta)
        function normalizarData(data) {
            if (!data) return null;
            // Se j√° est√° em formato YYYY-MM-DD, retorna como est√°
            if (typeof data === 'string' && /^\d{4}-\d{2}-\d{2}/.test(data)) {
                return data.split('T')[0]; // Remove hora se houver
            }
            // Tenta converter para Date e depois para YYYY-MM-DD
            try {
                const date = new Date(data);
                return date.toISOString().split('T')[0];
            } catch (e) {
                return null;
            }
        }

        // Fun√ß√£o auxiliar para buscar escala de hoje ou pr√≥xima dispon√≠vel (usada em todas as fun√ß√µes)
        async function buscarEscalaHoje() {
            try {
                const escalas = await carregarEscalas();
                if (!escalas || escalas.length === 0) {
                    console.log('Nenhuma escala retornada da API');
                    return null;
                }
                
                const hoje = new Date().toISOString().split('T')[0];
                const escalasMotorista = escalas.filter(e => e.motorista_id === usuarioAtual.id);
                
                if (escalasMotorista.length === 0) {
                    console.log('Nenhuma escala encontrada para este motorista');
                    return null;
                }
                
                // Debug: verificar escalas encontradas
                console.log('Escalas do motorista:', escalasMotorista);
                console.log('Data de hoje:', hoje);
                
                // Primeiro, tentar encontrar escala de hoje
                let escalaEncontrada = escalasMotorista.find(e => {
                    const dataEscala = normalizarData(e.data);
                    const dataOriginal = e.data;
                    console.log(`Comparando: ${dataEscala} === ${hoje} (original: ${dataOriginal})`);
                    return dataEscala === hoje;
                });
                
                // Se n√£o encontrou para hoje, buscar a pr√≥xima escala dispon√≠vel (hoje ou futura)
                if (!escalaEncontrada) {
                    const hojeTimestamp = new Date(hoje).getTime();
                    const escalasFuturas = escalasMotorista
                        .map(e => {
                            const dataNormalizada = normalizarData(e.data);
                            return {
                                ...e,
                                dataNormalizada: dataNormalizada,
                                timestamp: new Date(dataNormalizada).getTime()
                            };
                        })
                        .filter(e => e.timestamp >= hojeTimestamp && !isNaN(e.timestamp))
                        .sort((a, b) => a.timestamp - b.timestamp); // Ordenar por data mais pr√≥xima
                    
                    if (escalasFuturas.length > 0) {
                        escalaEncontrada = escalasFuturas[0];
                        console.log('Escala futura encontrada (pr√≥xima dispon√≠vel):', escalaEncontrada);
                    }
                } else {
                    console.log('Escala de hoje encontrada:', escalaEncontrada);
                }
                
                if (!escalaEncontrada) {
                    console.log('Nenhuma escala encontrada (hoje ou futura)');
                }
                
                return escalaEncontrada || null;
            } catch (error) {
                console.error('Erro ao buscar escala:', error);
                return null;
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar se usu√°rio est√° logado
            const usuario = localStorage.getItem('usuarioAtual');
            if (!usuario) {
                window.location.href = 'login.html';
                return;
            }

            usuarioAtual = JSON.parse(usuario);
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar && usuarioAtual.nome) {
                userAvatar.textContent = usuarioAtual.nome.charAt(0).toUpperCase();
            }
            
            // Carregar dados iniciais
            await loadDashboard();
            await loadEscalas();
            await loadStatusLinha();
        });

        // Fun√ß√£o para abrir tabs
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }

            tablinks = document.getElementsByClassName("tab-btn");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }

            document.getElementById(tabName).style.display = "block";
            setTimeout(() => {
                document.getElementById(tabName).classList.add("active");
            }, 10);
            
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add("active");
            }
            
            // Carregar dados espec√≠ficos
            switch(tabName) {
                case 'escala':
                    loadEscalas();
                    break;
                case 'controle':
                    // Sempre recarregar status da linha para garantir dados atualizados da escala
                    loadStatusLinha();
                    break;
            }
        }

        // Carregar dashboard
        async function loadDashboard() {
            try {
                // Usar a fun√ß√£o auxiliar para garantir sincroniza√ß√£o
                const escalaHoje = await buscarEscalaHoje();
                
                document.getElementById('statusLinha').textContent = statusLinha === 'parado' ? 'Parada' : 'Em Opera√ß√£o';
                document.getElementById('statusDesc').textContent = statusLinha === 'parado' ? 'Aguardando in√≠cio da jornada' : 'Linha em opera√ß√£o';
                
                if (escalaHoje) {
                    const horarioInicio = escalaHoje.horario_inicio || escalaHoje.horario?.split(' - ')[0] || 'N/A';
                    const horarioFim = escalaHoje.horario_fim || escalaHoje.horario?.split(' - ')[1] || '';
                    const linhaNome = escalaHoje.rota_nome || escalaHoje.linha || 'N/A';
                    
                    document.getElementById('escalaHoje').textContent = horarioInicio;
                    document.getElementById('escalaDesc').textContent = linhaNome;
                } else {
                    document.getElementById('escalaHoje').textContent = 'N/A';
                    document.getElementById('escalaDesc').textContent = 'Sem escala para hoje';
                }
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                document.getElementById('escalaHoje').textContent = 'N/A';
                document.getElementById('escalaDesc').textContent = 'Erro ao carregar escala';
            }
        }

        // Carregar escalas
        async function loadEscalas() {
            const container = document.getElementById('escalasList');
            if (!container) return;
            
            try {
                const escalas = await carregarEscalas();
                const escalasMotorista = escalas.filter(e => e.motorista_id === usuarioAtual.id);
                
                container.innerHTML = '';
                
                if (escalasMotorista.length === 0) {
                    container.innerHTML = '<p class="stat-desc">Nenhuma escala encontrada.</p>';
                    return;
                }
                
                const hoje = new Date().toISOString().split('T')[0];
                
                escalasMotorista.forEach(escala => {
                    const dataEscala = normalizarData(escala.data);
                    const isHoje = dataEscala === hoje;
                    
                    const escalaCard = document.createElement('div');
                    escalaCard.className = 'card';
                    escalaCard.style.marginBottom = '20px';
                    if (isHoje) {
                        escalaCard.style.border = '2px solid var(--success)';
                        escalaCard.style.backgroundColor = '#f0fdf4';
                    }
                    escalaCard.innerHTML = `
                        <div class="card-header">
                            <h3 class="card-title">${escala.data} - ${escala.turno || 'Turno'}</h3>
                            ${isHoje ? '<span style="background: var(--success); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem;">Hoje</span>' : ''}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                            <div>
                                <p class="stat-desc">Hor√°rio</p>
                                <p style="font-weight: 600;">${escala.horario_inicio} - ${escala.horario_fim}</p>
                            </div>
                            <div>
                                <p class="stat-desc">Linha</p>
                                <p style="font-weight: 600;">${escala.rota_nome || escala.linha}</p>
                            </div>
                            <div>
                                <p class="stat-desc">Ve√≠culo</p>
                                <p style="font-weight: 600;">${escala.veiculo_numero || escala.veiculo}</p>
                            </div>
                            <div>
                                <p class="stat-desc">Status</p>
                                <span style="background: ${escala.status === 'confirmado' ? 'var(--success)' : escala.status === 'pendente' ? 'var(--accent)' : 'var(--danger)'}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem;">${escala.status}</span>
                            </div>
                        </div>
                        ${isHoje ? `
                        <div style="margin-top: 15px; padding: 12px; background: #e0f2fe; border-left: 4px solid var(--primary); border-radius: 8px;">
                            <p style="margin: 0; color: var(--text-dark); font-size: 0.9rem;">
                                <i class="fas fa-link" style="margin-right: 5px; color: var(--primary);"></i>
                                Esta escala est√° conectada ao <a href="#" onclick="openTab(event, 'controle')" style="color: var(--primary); text-decoration: underline; font-weight: 600;">Controle de Linha</a>
                            </p>
                        </div>
                        ` : ''}
                    `;
                    container.appendChild(escalaCard);
                });
            } catch (error) {
                console.error('Erro ao carregar escalas:', error);
                container.innerHTML = '<p class="stat-desc">Erro ao carregar escalas.</p>';
            }
        }

        // Carregar status da linha
        async function loadStatusLinha() {
            try {
                // Sempre buscar a escala de hoje usando a fun√ß√£o auxiliar para garantir sincroniza√ß√£o
                escalaAtual = await buscarEscalaHoje();
            
            if (!escalaAtual) {
                const statusTitle = document.getElementById('statusTitle');
                const statusSubtitle = document.getElementById('statusSubtitle');
                const btnControle = document.getElementById('btnControle');
                const veiculoAtual = document.getElementById('veiculoAtual');
                const horarioAtual = document.getElementById('horarioAtual');
                const linhaAtual = document.getElementById('linhaAtual');
                const statusIcon = document.getElementById('statusIcon');
                
                if (statusTitle) statusTitle.textContent = 'Sem Escala para Hoje';
                if (statusSubtitle) {
                    statusSubtitle.innerHTML = 'Nenhuma escala encontrada para hoje. <a href="#" onclick="openTab(event, \'escala\')" style="color: var(--primary); text-decoration: underline; font-weight: 600;">Ver Minha Escala</a>';
                }
                if (btnControle) {
                    btnControle.style.display = 'none';
                }
                if (veiculoAtual) veiculoAtual.textContent = 'N/A';
                if (horarioAtual) horarioAtual.textContent = 'N/A';
                if (linhaAtual) linhaAtual.textContent = 'N/A';
                if (statusIcon) {
                    statusIcon.innerHTML = '<i class="fas fa-calendar-times"></i>';
                    statusIcon.style.background = '#fee2e2';
                    statusIcon.style.color = '#ef4444';
                }
                
                // Atualizar indicador visual
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                if (statusIndicator) {
                    statusIndicator.style.background = '#ef4444';
                }
                if (statusText) {
                    statusText.textContent = 'Status: Sem Escala';
                }
                return;
            }
            
            const veiculoAtual = document.getElementById('veiculoAtual');
            const horarioAtual = document.getElementById('horarioAtual');
            const linhaAtual = document.getElementById('linhaAtual');
            const btnControle = document.getElementById('btnControle');
            
            // Preencher informa√ß√µes da escala automaticamente
            if (veiculoAtual) veiculoAtual.textContent = escalaAtual.veiculo_numero || escalaAtual.veiculo || 'N/A';
            if (horarioAtual) horarioAtual.textContent = `${escalaAtual.horario_inicio} - ${escalaAtual.horario_fim}`;
            if (linhaAtual) linhaAtual.textContent = escalaAtual.rota_nome || escalaAtual.rota || 'N/A';
            
            // Preencher veiculoSelecionado automaticamente da escala
            veiculoSelecionado = escalaAtual.veiculo_numero || escalaAtual.veiculo || null;
            
            // Habilitar bot√£o de controle automaticamente quando h√° escala
            if (btnControle) {
                btnControle.disabled = false;
                btnControle.style.opacity = '1';
                btnControle.style.cursor = 'pointer';
                btnControle.style.display = 'block';
            }
            
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusSubtitle = document.getElementById('statusSubtitle');
            
            if (statusLinha === 'parado') {
                if (statusIcon) {
                    statusIcon.className = 'status-icon status-parado';
                    statusIcon.innerHTML = '<i class="fas fa-pause"></i>';
                }
                if (statusTitle) statusTitle.textContent = 'Linha Parada';
                if (statusSubtitle) statusSubtitle.textContent = 'Aguardando in√≠cio da jornada';
                if (btnControle) {
                    btnControle.innerHTML = '<i class="fas fa-play" id="btnIcon"></i> <span id="btnText">Iniciar Linha</span>';
                    btnControle.className = 'btn btn-success btn-lg';
                }
                
                // Atualizar indicador visual
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                if (statusIndicator) {
                    statusIndicator.style.background = '#6b7280';
                }
                if (statusText) {
                    statusText.textContent = 'Status: Parada';
                }
            } else {
                if (statusIcon) {
                    statusIcon.className = 'status-icon status-rodando';
                    statusIcon.innerHTML = '<i class="fas fa-play"></i>';
                }
                if (statusTitle) statusTitle.textContent = 'Linha em Opera√ß√£o';
                if (statusSubtitle) statusSubtitle.textContent = 'Jornada em andamento';
                if (btnControle) {
                    btnControle.innerHTML = '<i class="fas fa-stop" id="btnIcon"></i> <span id="btnText">Finalizar Linha</span>';
                    btnControle.className = 'btn btn-danger btn-lg';
                }
                
                // Atualizar indicador visual
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                if (statusIndicator) {
                    statusIndicator.style.background = '#10b981';
                }
                if (statusText) {
                    statusText.textContent = 'Status: Em Opera√ß√£o';
                }
            }
            } catch (error) {
                console.error('Erro ao carregar status da linha:', error);
            }
        }


        // Toggle linha
        async function toggleLinha() {
            if (!escalaAtual) {
                showNotification('Nenhuma escala encontrada para hoje!', 'error');
                return;
            }
            
            if (!veiculoSelecionado) {
                showNotification('Ve√≠culo n√£o encontrado na escala!', 'error');
                return;
            }
            
            if (statusLinha === 'parado') {
                // Buscar escala atual do motorista usando fun√ß√£o auxiliar
                try {
                    const escalaHoje = await buscarEscalaHoje();
                    
                    if (!escalaHoje) {
                        showNotification('Nenhuma escala encontrada para hoje!', 'error');
                        return;
                    }
                    
                    // Atualizar escalaAtual para garantir sincroniza√ß√£o
                    escalaAtual = escalaHoje;
                    
                    // Obter localiza√ß√£o atual
                    let latitude = null;
                    let longitude = null;
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((position) => {
                            latitude = position.coords.latitude;
                            longitude = position.coords.longitude;
                        });
                    }
                    
                    // Registrar in√≠cio de linha no banco
                    const inicioData = {
                        motorista_id: usuarioAtual.id,
                        escala_id: escalaHoje.id,
                        rota_id: escalaHoje.rota_id,
                        veiculo_id: escalaHoje.veiculo_id,
                        latitude: latitude,
                        longitude: longitude
                    };
                    
                    const response = await iniciarLinhaAPI(inicioData);
                    if (response.success) {
                        statusLinha = 'rodando';
                        adicionarLinhaHistorico('iniciada');
                        showNotification('Linha iniciada com sucesso! Boa jornada!', 'success');
                        
                        // Atualizar status em todas as √°reas imediatamente
                        await loadStatusLinha();
                        await loadDashboard();
                    } else {
                        showNotification('Erro ao iniciar linha: ' + (response.error || 'Erro desconhecido'), 'error');
                    }
                } catch (error) {
                    console.error('Erro ao iniciar linha:', error);
                    showNotification('Erro ao iniciar linha. Tente novamente.', 'error');
                }
            } else {
                statusLinha = 'parado';
                adicionarLinhaHistorico('finalizada');
                showNotification('Linha finalizada com sucesso! Desejo um bom descanso!', 'success');
                
                // Verificar se todas as linhas foram feitas
                setTimeout(() => {
                    if (historicoLinhas.length >= 3) {
                        showNotification('Parab√©ns! Voc√™ completou todas as suas linhas de hoje. Tenha um √≥timo descanso!', 'success');
                    }
                }, 2000);
                
                // Atualizar status em todas as √°reas imediatamente
                await loadStatusLinha();
                await loadDashboard();
            }
        }

        // Adicionar linha ao hist√≥rico
        function adicionarLinhaHistorico(acao) {
            const agora = new Date();
            const linha = {
                id: Date.now(),
                veiculo: `√înibus ${veiculoSelecionado}`,
                linha: document.getElementById('linhaAtual').textContent,
                acao: acao,
                horario: agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                data: agora.toLocaleDateString('pt-BR')
            };
            
            historicoLinhas.unshift(linha);
            atualizarHistorico();
        }

        // Atualizar hist√≥rico
        function atualizarHistorico() {
            const container = document.getElementById('historicoLinhas');
            
            if (historicoLinhas.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">Nenhuma linha executada hoje</p>';
                return;
            }
            
            container.innerHTML = historicoLinhas.map(linha => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${linha.acao === 'iniciada' ? '#10b981' : '#f59e0b'};">
                    <div>
                        <p style="font-weight: 600; color: #1f2937; margin: 0;">${linha.veiculo} - ${linha.linha}</p>
                        <p style="font-size: 0.875rem; color: #6b7280; margin: 5px 0 0 0;">${linha.acao === 'iniciada' ? 'Iniciada' : 'Finalizada'} √†s ${linha.horario}</p>
                    </div>
                    <span style="background: ${linha.acao === 'iniciada' ? '#dcfce7' : '#fef3c7'}; color: ${linha.acao === 'iniciada' ? '#166534' : '#92400e'}; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                        ${linha.acao === 'iniciada' ? 'EM ANDAMENTO' : 'FINALIZADA'}
                    </span>
                </div>
            `).join('');
        }

        // Handle formul√°rio de problema
        document.getElementById('problemaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const tipoProblema = document.getElementById('tipoProblema').value;
            const descricao = document.getElementById('descricaoProblema').value;
            const urgencia = document.getElementById('urgencia').value;
            
            if (!tipoProblema || !descricao || !urgencia) {
                showNotification('Por favor, preencha todos os campos.', 'error');
                return;
            }
            
            // Obter ve√≠culo da escala atual
            let veiculoId = null;
            if (escalaAtual && escalaAtual.veiculo_id) {
                veiculoId = escalaAtual.veiculo_id;
            }
            
            if (!veiculoId) {
                showNotification('Erro: Ve√≠culo n√£o encontrado na escala. Verifique sua escala.', 'error');
                return;
            }
            
            try {
                const chamado = {
                    motorista_id: usuarioAtual.id,
                    veiculo_id: veiculoId,
                    tipo: tipoProblema,
                    descricao: descricao,
                    urgencia: urgencia
                };
                
                const response = await criarChamadoAPI(chamado);
                
                if (response.success) {
                    // Limpar formul√°rio
                    document.getElementById('problemaForm').reset();
                    showNotification('Chamado enviado com sucesso! Nossa equipe t√©cnica ser√° notificada.', 'success');
                } else {
                    showNotification('Erro ao enviar chamado: ' + (response.error || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                console.error('Erro ao criar chamado:', error);
                showNotification('Erro ao enviar chamado. Tente novamente.', 'error');
            }
        });

        // Fun√ß√µes utilit√°rias
        function formatarData(dataString) {
            const data = new Date(dataString);
            return data.toLocaleString('pt-BR');
        }

        function logout() {
            localStorage.removeItem('usuarioAtual');
            window.location.href = 'login.html';
        }

        // Modal de Perfil
        function abrirModalPerfil() {
            document.getElementById('modalPerfil').style.display = 'block';
        }

        function fecharModalPerfil() {
            document.getElementById('modalPerfil').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        document.getElementById('modalPerfil').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalPerfil();
            }
        });

        function showNotification(message, type = 'info') {
            // Criar elemento de notifica√ß√£o
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                padding: 15px 20px;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                border: 2px solid ${type === 'success' ? '#059669' : type === 'error' ? '#dc2626' : '#2563eb'};
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animar entrada
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remover ap√≥s 4 segundos
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>